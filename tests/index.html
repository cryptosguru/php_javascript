<!DOCTYPE html>
<html>
    <head>
        <title>php.js test suite</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="src/include.js"></script>
        <script src="src/lib/diff_match_patch.js"></script>
        <style>
            body {
                font-family: Arial, Sans-Serif;
                font-size:11px;
            }

            ins {

                background:#E6FFE6;
            }
            del {
                background:#FFE6E6;
            }

            li {
                white-space: pre;
            }

        </style>

        <script>
            // PHP.Tokenizer("sup");
            
            function PHP_Tests( type, elem ) {
                this.elem = elem;
                this.type = type;
                this.cache = {};
                
                // this.buildTest( 'php/classes/__call_004.phpt' );
                this.loadTests( type );
            }
            
            PHP_Tests.prototype.loadTests = function( type ) {
                
                var ul  = document.createElement('ul'),
                $this = this;
                
                this.loadJSON('/?tests=' + type, function( tests ) {
                    tests.forEach(function( testFile ){
                        var li = document.createElement('li');
                        li.appendChild( document.createTextNode( testFile ) )
                        ul.appendChild(li  );
                        
                    }, this);
                    
                    
                    this.elem.appendChild( ul );
                    
                });
                
                ul.addEventListener( "click", function( event ){
                    var li = event.target;
                    if (!/li/i.test( li.nodeName )) {
                        return;
                    }
                    
                    $this.runTest( li );
                    
                }, false );
            };
            
            PHP_Tests.prototype.runTest = function( li ) {
                var testFile = li.childNodes[ 0 ].nodeValue;
                this.buildTest( 'php/' + this.type + '/' + testFile, function( test, engine ) {
                  
                    li.setAttribute( 'title', test.TEST );
                    
                    if (engine.error !== undefined) {
                        li.style.color = "red";
                        throw new Error( engine.error );
                    }
                    
                    var expect = ((test.EXPECT === undefined) ? test.EXPECTF : test.EXPECT ).trim(),
                    output = engine.vm.OUTPUT_BUFFER.replace(/\n/g, "\r\n").trim(),
                    expectResult;
                    

                    // expect.replace(/\r/g,"");
                    
                    if (test.EXPECT === undefined ) {
                        var shouldBef = expect.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&");
                        shouldBef = shouldBef.replace(/\%d/g,"\\d+");
                        shouldBef = shouldBef.replace(/\%s/g,"\\S+");
                        shouldBef = shouldBef.replace(/\%S/g,".*?");
                        
                        var re = new RegExp("^" + shouldBef + "$", "i");
                         
                        expectResult = re.test( output );
                        
                    } else {
                        expectResult = (expect === output);
                    }
                    
                    if ( expectResult ) {
                        // if ( expect === engine.vm.OUTPUT_BUFFER ) {
                        li.style.color = "green";
                        console.log( "-----OUTPUTTED-----", output );
                    } else {
                        this.diff( expect, output );
                        //li.style.color = "red";
                        console.log( test );
                  //      console.log( "-----EXPECTING-----", expect );
                  //      console.log( "-----OUTPUTTED-----", output );
                        var div = document.createElement("div");
                        var dmp = new diff_match_patch();
                        
                        var d = dmp.diff_main( expect, output );
                        dmp.diff_cleanupSemantic( d );
                      
                        div.innerHTML = dmp.diff_prettyHtml( d );
                        li.appendChild( div );
                        
                    }
                    console.log( engine );
                    
                    
                } );
                console.log( testFile );
            };
            
            PHP_Tests.prototype.diff = function( expect, result ) {
                
                var len = expect.length;
                
                
                for (var i = 0; i < len; i++) {
                    if (expect[ i ] !== result[ i ]) {
                        console.log( i, expect[ i ], result[ i ], expect.charCodeAt( i ), result.charCodeAt( i ), expect.charCodeAt( i + 1 ), result.charCodeAt( i + 1 ), expect.charCodeAt( i - 1 ), result.charCodeAt( i - 1 ) );
                        return;
                    }
                }
                
          
                
              
                
            };
            
            PHP_Tests.prototype.buildTest = function( path, callback ) {
              
                this.loadJSON('/?file=' + path, function( json ){
                    var engine = {};
                    //      try {
                    engine = new PHP( PHP.Lexer(json.FILE), {
                        POST: ( json.POST !== undefined ) ? PHP.Utils.QueryString( json.POST ) : {},
                        GET: ( json.GET !== undefined ) ? PHP.Utils.QueryString( json.GET ) : {},
                        SERVER: {
                            SCRIPT_FILENAME: path
                        //    SCRIPT_FILENAME: "%s"
                        }
                    } );
                    //    } catch( e ) {
                    //      engine.error = e;
                    //  }
                    
                    
                    callback.call( this, json, engine );  
                    
                });
                
            };
            
            PHP_Tests.prototype.loadJSON = function( file, callback ) {
                
                var xhr = new XMLHttpRequest(),
                $this = this;
                xhr.open('GET', file, true);
                xhr.responseType = 'text';

                xhr.onload = function() {
                    if (this.status == 200) {   
                        callback.call( $this, JSON.parse(this.response) );
                    }
                };

                xhr.send();
            };
            
           

            
        </script>
    </head>
    <body>
        <div id="tests"></div>
        <script>
            new PHP_Tests( "ext/tokenizer", document.getElementById("tests") );
            
        </script>
    </body>
</html>
